{#
# Copyright 2015 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#}

{% extends "base.html" %}

{% block content %}

<div class="container">
<h3 class="d-inline-block">Plans</h3>
<a href="/plans/addplan?family={{family.key.id}}" class="btn btn-success btn-sm d-inline-block">
  <i class="glyphicon glyphicon-plus"></i>
  Add plan
</a>


<div class="plan_comparison container">
  <div class="row">
    <div class="col-4">
    </div>
    <div class="col-2">
      <div class="d-inline-block legend-color-box legend-start" style="background: #1f77b4"></div>
      <small class="d-inline-block legend-title-start">Premium</small>
    </div>
    <div class="col-2">
      <div class="d-inline-block legend-color-box" style="background: #ff7f0e"></div>
      <small class="d-inline-block legend-title">Deductible</small>
    </div>
    <div class="col-2">
      <div class="d-inline-block legend-color-box" style="background: #2ca02c"></div>
      <small class="d-inline-block legend-title">Employee Funding Into Account</small>
    </div>
    <div class="col-2">
      <div class="d-inline-block legend-color-box" style="background: #000000"></div>
      <small class="d-inline-block legend-title">Out Of Pocket Maximum</small>
    </div>
  
  </div>

{% for plan in plans %}
  <div class="row">
    <div class="col-4">
      <h5><a href="/plans/{{plan.key.id}}">{{plan.plan_name}}</a></h5>
    </div>
    <div class="col-8"><svg class="plan_{{plan.key.id}}_details" width="500" height="100"></svg></div>
  </div>
{% endfor %}  
</div>

<a href="/plans/finish?family={{family.key.id}}" role="button" class="btn btn-primary btn-lg">Find the best plan for me</a>

<script type="text/javascript" src="https://dl.dropboxusercontent.com/u/1096641/d3-tip.js"></script>
<script>
var data = [
{% for plan in plans %}
  {plan_name: "{{plan.plan_name}}", premium: {{plan.ee_cost|int}}, premium_cycle: "{{plan.ee_cost_cycle}}", deductible: {{plan.ee_deductible|int}}, oop: {{plan.ee_oop_max|int}}, funding: {{plan.ee_er_funding|int}}},
{%endfor%}
];

for (var i = 0; i < data.length; i++) {
  cycle = data[i].premium_cycle;
  if (cycle == "Weekly") {data[i].premium *= 52;}
  else if (cycle == "Bi-Weekly (Twice a month)") {data[i].premium *= 26;}
  else if (cycle == "Monthly") {data[i].premium *= 12;}
  else if (cycle == "Semi-Anunally") {data[i].premium *= 2;}
}

var series = d3.stack()
    .keys(["premium", "deductible", "funding", "oop"])
    .offset(d3.stackOffsetNone)
    (data);

{% for plan in plans %}
var data = [
  {plan_name: "{{plan.plan_name}}", premium: {{plan.ee_cost|default("0")|int}}, premium_cycle: "{{plan.ee_cost_cycle}}", deductible: {{plan.ee_deductible|default("0")|int}}, oop: {{plan.ee_oop_max|default("0")|int}}, funding: {{plan.ee_er_funding|default("0")|int}}},
];
for (var i = 0; i < data.length; i++) {
  cycle = data[i].premium_cycle;
  if (cycle == "Weekly") {data[i].premium *= 52;}
  else if (cycle == "Bi-Weekly (Twice a month)") {data[i].premium *= 26;}
  else if (cycle == "Monthly") {data[i].premium *= 12;}
  else if (cycle == "Semi-Anunally") {data[i].premium *= 2;}
}

data_item = [data[0]];

var series_item = d3.stack()
    .keys(["premium", "deductible", "funding", "oop"])
    .offset(d3.stackOffsetNone)
    (data_item);

var width = 420;

var svg = d3.select(".plan_{{plan.key.id}}_details"),
    margin = {top: 10, right: 10, bottom: 20, left: 10},
    width = +svg.attr("width"),
    height = +svg.attr("height");

var x = d3.scaleLinear()
    .domain([0, d3.max(series, stackMax)])
    .rangeRound([margin.left, width - margin.right]);

var y = d3.scaleBand()
    .domain(data_item.map(function(d) { return d.plan_name; }))
    .rangeRound([height - margin.bottom, margin.top]);
var z = d3.scaleOrdinal(d3.schemeCategory10);

svg.append("g")
    .attr("transform", "translate(0," + (height - margin.bottom) + ")")
    .call(d3.axisBottom(x).tickFormat(d3.formatPrefix(".0", 1e3)));

var tip = d3.tip()
      .attr("class", "d3-tip")
      .offset([-8, 0])
      .html(function(d) { 
        console.log(d);
        if (typeof d == 'object') {
          var title;
          if(d[0] === 0) { title = "Premium";}
          else if(d[0] === d.data.premium) { title = "Deductible";}
          else if(d[0] === d.data.premium + d.data.deductible) { title = "Funding";}
          return title + ": $"+ (d[1] - d[0]);
        }
        else {return "Out Of Pocket Maximum: $" + d;}
      });
svg.call(tip);

// Add marker
console.log(series_item);

marker_data = series_item[3][0];
// var marker = svg.selectAll("line.marker");
svg.append("line")
  .data(marker_data)
  .attr("x1", x(marker_data[1]))
  .attr("x2", x(marker_data[1]))
  .attr("y2", (height - margin.bottom))
  .attr("y1", margin.top)
  .attr("stroke-width", 2)
  .attr("stroke", "black")
  .on('mouseover', tip.show)
  .on('mouseout', tip.hide);


series_item = series_item.slice(0,3)

svg.append("g")
  .selectAll("g")
  .data(series_item)
  .enter().append("g")
    .attr("fill", function(d) { return z(d.key); })
  .selectAll("rect")
  .data(function(d) { return d; })
  .enter().append("rect")
    .attr("class", "bar")
    .attr("height", y.bandwidth)
    .attr("y", function(d) { return y(d.data.plan_name); })
    .attr("x", function(d) { return x(d[0]); })
    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    .on('mouseover', tip.show)
    .on('mouseout', tip.hide);


{% endfor %}  

function stackMin(serie) {
  return d3.min(serie, function(d) { return d[0]; });
}

function stackMax(serie) {
  return d3.max(serie, function(d) { return d[1]; });
}

function stackOffsetDiverging(series, order) {
  if (!((n = series.length) > 1)) return;
  for (var i, j = 0, d, dy, yp, yn, n, m = series[order[0]].length; j < m; ++j) {
    for (yp = yn = 0, i = 0; i < n; ++i) {
      if ((dy = (d = series[order[i]][j])[1] - d[0]) >= 0) {
        d[0] = yp, d[1] = yp += dy;
      } else if (dy < 0) {
        d[1] = yn, d[0] = yn += dy;
      } else {
        d[0] = yp;
      }
    }
  }
}

</script>
</div>
{% endblock %}
