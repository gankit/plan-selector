{#
# Copyright 2015 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#}

{% extends "base.html" %}

{% block content %}

<h3>Plans</h4>
<a href="/plans/addplan?family={{family.key.id}}" class="btn btn-success btn-sm">
  <i class="glyphicon glyphicon-plus"></i>
  Add plan
</a>

<h4>Your Plans</h4>
<ul>
{% for plan in plans %}
{% if plan.plan_source == 'employer' %}<li><a href="/plans/{{plan.key.id}}">{{plan.plan_name}}</a> by {{plan.insurer_name}}</li> {% endif %}
{% endfor %}
</ul>

<h4>Your Spouse's Plans</h4>
<ul>
{% for plan in plans %}
{% if plan.plan_source == 'spouse_employer' %}<li><a href="/plans/{{plan.key.id}}">{{plan.plan_name}}</a> by {{plan.insurer_name}}</li> {% endif %}
{% endfor %}
</ul>

<h4>Other Plans</h4>
<ul>
{% for plan in plans %}
{% if plan.plan_source == 'other' %}<li><a href="/plans/{{plan.key.id}}">{{plan.plan_name}}</a> by {{plan.insurer_name}}</li> {% endif %}
{% endfor %}
</ul>

<svg width="500" height="300"></svg>
<script>

var data = [
{% for plan in plans %}
  {plan_name: "{{plan.plan_name}}", premium: {{plan.ee_cost|int}}, premium_cycle: "{{plan.ee_cost_cycle}}", deductible: {{plan.ee_deductible|int}}, oop: {{plan.ee_oop_max|int}}},
{% endfor %}  
];


for (var i = 0; i < data.length; i++) {
  cycle = data[i].premium_cycle;
  if (cycle == "Weekly") {data[i].premium *= 52;}
  else if (cycle == "Bi-Weekly (Twice a month)") {data[i].premium *= 26;}
  else if (cycle == "Monthly") {data[i].premium *= 12;}
  else if (cycle == "Semi-Anunally") {data[i].premium *= 2;}
}

// var data = [
//   {month: "Q1-2016", apples: 3840, bananas: 1920, cherries: -1960, dates: -400},
//   {month: "Q2-2016", apples: 1600, bananas: 1440, cherries: -960, dates: -400},
//   {month: "Q3-2016", apples:  640, bananas:  960, cherries: -640, dates: -600},
//   {month: "Q4-2016", apples:  320, bananas:  480, cherries: -640, dates: -400}
// ];
console.log(data);
var series = d3.stack()
    // .keys(["apples", "bananas", "cherries", "dates"])
    .keys(["premium", "deductible", "oop"])
    .offset(stackOffsetDiverging)
    (data);
console.log(series);

var svg = d3.select("svg"),
    margin = {top: 20, right: 30, bottom: 30, left: 60},
    width = +svg.attr("width"),
    height = +svg.attr("height");

var x = d3.scaleBand()
    .domain(data.map(function(d) { return d.plan_name; }))
    .rangeRound([margin.left, width - margin.right])
    .padding(0.1);

var y = d3.scaleLinear()
    .domain([d3.min(series, stackMin), d3.max(series, stackMax)])
    .rangeRound([height - margin.bottom, margin.top]);

var z = d3.scaleOrdinal(d3.schemeCategory10);

svg.append("g")
  .selectAll("g")
  .data(series)
  .enter().append("g")
    .attr("fill", function(d) { return z(d.key); })
  .selectAll("rect")
  .data(function(d) { return d; })
  .enter().append("rect")
    .attr("width", x.bandwidth)
    .attr("x", function(d) { return x(d.data.plan_name); })
    .attr("y", function(d) { return y(d[1]); })
    .attr("height", function(d) { return y(d[0]) - y(d[1]); })

svg.append("g")
    .attr("transform", "translate(0," + y(0) + ")")
    .call(d3.axisBottom(x));

svg.append("g")
    .attr("transform", "translate(" + margin.left + ",0)")
    .call(d3.axisLeft(y));

function stackMin(serie) {
  return d3.min(serie, function(d) { return d[0]; });
}

function stackMax(serie) {
  return d3.max(serie, function(d) { return d[1]; });
}

function stackOffsetDiverging(series, order) {
  if (!((n = series.length) > 1)) return;
  for (var i, j = 0, d, dy, yp, yn, n, m = series[order[0]].length; j < m; ++j) {
    for (yp = yn = 0, i = 0; i < n; ++i) {
      if ((dy = (d = series[order[i]][j])[1] - d[0]) >= 0) {
        d[0] = yp, d[1] = yp += dy;
      } else if (dy < 0) {
        d[1] = yn, d[0] = yn += dy;
      } else {
        d[0] = yp;
      }
    }
  }
}

</script>
{% endblock %}
